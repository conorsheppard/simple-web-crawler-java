#!/bin/zsh

IMAGE_NAME="conorsheppard/simple-web-crawler-java:latest"
ARGS="$*"
echo "$ARGS"
START_CONTAINERS=false
for arg in "$@"; do
    if [[ "$arg" == "--d" || "$arg" == "--dist" || "$arg" == "--distributed" ]]; then
        START_CONTAINERS=true
        break
    fi
done

if [[ "$START_CONTAINERS" == true ]]; then
    if docker ps -q -f name=kafka-web-crawler; then
        echo "üõë Kafka container is running. Stopping and removing it..."
        docker-compose down || { echo "‚ùå Docker Compose down failed!"; exit 1; }
    fi

    if docker ps -q -f name=redis-web-crawler; then
        echo "üõë Redis container is running. Stopping and removing it..."
        docker-compose down || { echo "‚ùå Docker Compose down failed!"; exit 1; }
    fi

    ARGS="https://books.toscrape.com --dist --threads 100" docker-compose up -d &

    while [[ -z $(docker-compose ps -q simple-web-crawler-java) || -z $(docker ps -q -f id=$(docker-compose ps -q simple-web-crawler-java)) ]]; do
        echo "Waiting for simple-web-crawler-java container to start..."
        sleep 2
    done

    docker attach $(docker-compose ps -q simple-web-crawler-java)
else
    # Run the crawler container without starting Kafka and Redis
    echo "$@"
    export CRAWLER_ARGS="$@"
    docker run --rm "$IMAGE_NAME" "$CRAWLER_ARGS" || { echo "‚ùå Docker run failed!"; exit 1; }
fi