#!/bin/zsh

PROJECT_NAME="simple-web-crawler-java"
IMAGE_NAME="conorsheppard/simple-web-crawler-java:latest"

START_CONTAINERS=false
for arg in "$@"; do
    if [[ "$arg" == "--d" || "$arg" == "--dist" || "$arg" == "--distributed" ]]; then
        START_CONTAINERS=true
        break
    fi
done

if [[ "$START_CONTAINERS" == true ]]; then
    if docker ps -q -f name=kafka-web-crawler; then
        echo "üõë Kafka container is running. Stopping and removing it..."
        docker-compose down || { echo "‚ùå Docker Compose down failed!"; exit 1; }
    fi

    if docker ps -q -f name=redis-web-crawler; then
        echo "üõë Redis container is running. Stopping and removing it..."
        docker-compose down || { echo "‚ùå Docker Compose down failed!"; exit 1; }
    fi

    export CRAWLER_ARGS="$@"
    docker-compose up || { echo "‚ùå Docker Compose up failed!"; exit 1; }
else
    # Run the crawler container without starting Kafka and Redis
    docker run --rm "$IMAGE_NAME" "$@" || { echo "‚ùå Docker run failed!"; exit 1; }
fi