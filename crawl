#!/bin/zsh

PROJECT_NAME="simple-web-crawler-java"
JAR_FILE="target/${PROJECT_NAME}-1.0-SNAPSHOT.jar"
MAIN_CLASS="com.conorsheppard.Application"
QUEUE_TYPE="ConcurrentQueue"  # Default queue type
CACHE_TYPE="InMemoryCache"  # Default cache type
MAX_THREADS=10  # Default thread count
WEBSITE_URL=""

# Check if Maven build is needed
if [[ ! -f "$JAR_FILE" ]]; then
    echo "üì¶ Building project with Maven..."
    mvn clean package || { echo "‚ùå Build failed!"; exit 1; }
fi

# Parse positional argument (if provided first)
if [[ "$#" -gt 0 && "$1" != --* ]]; then
    WEBSITE_URL="$1"
    shift  # Remove the first argument for further processing
fi

# Parse named flags
while [[ "$#" -gt 0 ]]; do
    case "$1" in
        --url) WEBSITE_URL="$2"; shift 2 ;;
        --queue) QUEUE_TYPE="$2"; shift 2 ;;
        --cache) CACHE_TYPE="$2"; shift 2 ;;
        --threads) MAX_THREADS="$2"; shift 2 ;;
        --help)
            echo "Usage: ./crawl.sh <website-url> OR --url <website-url> [--queue <queue-type>] [--cache <cache-type>] [--threads <max-threads>]"
            exit 0
            ;;
        *)
            echo "‚ö†Ô∏è Unknown option: $1"
            exit 1
            ;;
    esac
done

# Ensure URL is provided
if [[ -z "$WEBSITE_URL" ]]; then
    echo "‚ùå Error: A website URL is required."
    echo "Usage: ./crawl.sh <website-url> OR --url <website-url> [--queue <queue-type>] [--cache <cache-type>] [--threads <max-threads>]"
    exit 1
fi

# Run the Java application
echo "üöÄ Running web crawler..."
echo "üîó URL: $WEBSITE_URL"
echo "üóÇ Queue Type: $QUEUE_TYPE"
echo "üõ† Cache Type: $CACHE_TYPE"
echo "‚ö° Threads: $MAX_THREADS"

mvn exec:java -Dexec.mainClass="$MAIN_CLASS" -Dexec.args="$WEBSITE_URL -q $QUEUE_TYPE -c $CACHE_TYPE -t $MAX_THREADS"
